<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ† –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f4f4f4, #e0e0e0);
            color: #1a1a1a;
            margin: 0;
            padding: 20px;
            transition: background 0.3s ease, color 0.3s ease;
        }
        body.dark-theme {
            background: linear-gradient(135deg, #121212, #1e1e1e);
            color: #e0e0e0;
        }
        h1, h2 {
            color: #1a1a1a;
            text-align: center;
            font-weight: 700;
            margin-bottom: 20px;
        }
        body.dark-theme h1, body.dark-theme h2 {
            color: #e0e0e0;
        }
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: background 0.3s ease;
        }
        body.dark-theme .admin-container {
            background: rgba(30, 30, 30, 0.9);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }
        .admin-section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 10px;
            background: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark-theme .admin-section {
            background: #2c2c2c;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .admin-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        .admin-section label {
            display: flex;
            align-items: center;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .admin-section label i {
            margin-right: 8px;
            color: #007bff;
        }
        body.dark-theme .admin-section label i {
            color: #4da3ff;
        }
        .admin-section input, .admin-section select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .admin-section input:focus, .admin-section select:focus {
            border-color: #007bff;
            outline: none;
        }
        body.dark-theme .admin-section input, body.dark-theme .admin-section select {
            background: #3a3a3a;
            border-color: #555;
            color: #e0e0e0;
        }
        .admin-section button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 16px;
            transition: background 0.3s ease, transform 0.3s ease;
        }
        .admin-section button:hover {
            background: linear-gradient(135deg, #0056b3, #003f7f);
            transform: scale(1.05);
        }
        body.dark-theme .admin-section button {
            background: linear-gradient(135deg, #424242, #2e2e2e);
        }
        body.dark-theme .admin-section button:hover {
            background: linear-gradient(135deg, #757575, #555);
        }
        .error {
            color: #dc2626;
            font-size: 14px;
            margin-top: 8px;
            display: flex;
            align-items: center;
        }
        .error i {
            margin-right: 5px;
        }
        .activity-list, .report-list, .stats-display {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background: #f9f9f9;
            max-height: 300px;
            overflow-y: auto;
        }
        body.dark-theme .activity-list, body.dark-theme .report-list, body.dark-theme .stats-display {
            border-color: #555;
            background: #3a3a3a;
        }
        .activity-list p, .report-list div p {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        body.dark-theme .activity-list p, body.dark-theme .report-list div p {
            border-bottom: 1px solid #424242;
        }
        .stats-display canvas {
            margin-top: 15px;
        }
        .account-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        body.dark-theme .account-panel {
            background: linear-gradient(135deg, #424242, #3a3a3a);
        }
        .account-panel span {
            margin-right: 10px;
            font-weight: bold;
        }
        .account-panel button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .account-panel button:hover {
            background: linear-gradient(135deg, #0056b3, #003f7f);
        }
        body.dark-theme .account-panel button {
            background: linear-gradient(135deg, #424242, #2e2e2e);
        }
        body.dark-theme .account-panel button:hover {
            background: linear-gradient(135deg, #757575, #555);
        }
        .theme-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .theme-toggle:hover {
            background: linear-gradient(135deg, #0056b3, #003f7f);
        }
        body.dark-theme .theme-toggle {
            background: linear-gradient(135deg, #424242, #2e2e2e);
        }
        body.dark-theme .theme-toggle:hover {
            background: linear-gradient(135deg, #757575, #555);
        }
        @media (max-width: 768px) {
            .admin-container {
                padding: 20px;
            }
            .admin-section button {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleDarkTheme()"><i class="fas fa-moon"></i> –¢–µ–º–Ω–∞ —Ç–µ–º–∞</button>
    <div class="account-panel" id="accountPanel">
        <span id="userName">–ì—ñ—Å—Ç—å</span>
        <button id="authButton" onclick="signOutUser()"><i class="fas fa-sign-out-alt"></i> –í–∏–π—Ç–∏</button>
    </div>
    <h1><i class="fas fa-tools"></i> –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h1>
    <div class="admin-container">
        <!-- User Management -->
        <div class="admin-section">
            <h2><i class="fas fa-users-cog"></i> –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</h2>
            <label><i class="fas fa-ban"></i> –ë–∞–Ω/–†–æ–∑–±–∞–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:</label>
            <input type="email" id="banEmail" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞">
            <button onclick="banUser()"><i class="fas fa-ban"></i> –ó–∞–±–∞–Ω–∏—Ç–∏</button>
            <button onclick="unbanUser()"><i class="fas fa-unlock"></i> –†–æ–∑–±–∞–Ω–∏—Ç–∏</button>
            <p id="userError" class="error"></p>
            <label><i class="fas fa-chart-line"></i> –ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤:</label>
            <div id="userActivity" class="activity-list"></div>
        </div>

        <!-- Lesson Management -->
        <div class="admin-section">
            <h2><i class="fas fa-book"></i> –ö–µ—Ä—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫–∞–º–∏</h2>
            <label><i class="fas fa-trash-alt"></i> –í–∏–¥–∞–ª–∏—Ç–∏ —É—Ä–æ–∫ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏:</label>
            <select id="deleteLessonSelect">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å —É—Ä–æ–∫</option>
            </select>
            <button onclick="deleteCommunityLesson()"><i class="fas fa-trash"></i> –í–∏–¥–∞–ª–∏—Ç–∏</button>
            <label><i class="fas fa-comment-slash"></i> –í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä:</label>
            <select id="deleteCommentSelect">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä</option>
            </select>
            <button onclick="deleteComment()"><i class="fas fa-trash"></i> –í–∏–¥–∞–ª–∏—Ç–∏</button>
            <p id="lessonError" class="error"></p>
        </div>

        <!-- Quiz Management -->
        <div class="admin-section">
            <h2><i class="fas fa-puzzle-piece"></i> –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∫–≤—ñ–∑–∞–º–∏</h2>
            <label><i class="fas fa-edit"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–≤—ñ–∑:</label>
            <select id="editQuizSelect">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑</option>
            </select>
            <button onclick="openEditQuiz()"><i class="fas fa-pencil-alt"></i> –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
            <label><i class="fas fa-trash-alt"></i> –í–∏–¥–∞–ª–∏—Ç–∏ –∫–≤—ñ–∑:</label>
            <select id="deleteQuizSelect">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑</option>
            </select>
            <button onclick="deleteQuiz()"><i class="fas fa-trash"></i> –í–∏–¥–∞–ª–∏—Ç–∏</button>
            <label><i class="fas fa-check-circle"></i> –í–µ—Ä–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –∫–≤—ñ–∑:</label>
            <select id="verifyQuizSelect">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑</option>
            </select>
            <button onclick="toggleVerifyQuiz()"><i class="fas fa-toggle-on"></i> –ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—é</button>
            <label><i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–≤—ñ–∑–∞:</label>
            <select id="statsQuizSelect">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑</option>
            </select>
            <button onclick="showQuizStats()"><i class="fas fa-eye"></i> –ü–æ–∫–∞–∑–∞—Ç–∏</button>
            <div id="quizStats" class="stats-display"></div>
            <label><i class="fas fa-trophy"></i> –ë–∞–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:</label>
            <input type="email" id="manageScoreEmail" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞">
            <select id="manageScoreQuizSelect">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑</option>
            </select>
            <input type="number" id="newScore" placeholder="–ù–æ–≤–∏–π –±–∞–ª">
            <button onclick="updateUserScore()"><i class="fas fa-sync-alt"></i> –û–Ω–æ–≤–∏—Ç–∏</button>
            <p id="quizError" class="error"></p>
        </div>

        <!-- Report Management -->
        <div class="admin-section">
            <h2><i class="fas fa-exclamation-triangle"></i> –°–∫–∞—Ä–≥–∏</h2>
            <label><i class="fas fa-search"></i> –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Å–∫–∞—Ä–≥–∏:</label>
            <select id="reportQuizSelect">
                <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑</option>
            </select>
            <button onclick="viewReports()"><i class="fas fa-eye"></i> –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</button>
            <div id="reportList" class="report-list"></div>
            <p id="reportError" class="error"></p>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
        import { getFirestore, collection, doc, getDocs, getDoc, setDoc, updateDoc, deleteDoc, query, where, collectionGroup, writeBatch, increment } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDLJGPbMVGY-5b-aRbFlqgYSqn9c8azZ_E",
            authDomain: "bioworld-1.firebaseapp.com",
            projectId: "bioworld-1",
            storageBucket: "bioworld-1.firebasestorage.app",
            messagingSenderId: "691211086040",
            appId: "1:691211086040:web:7fcbbfaca4916e8b788fad",
            measurementId: "G-QE0SMWMVWE"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_EMAIL = 'petro.hryhorenko@gmail.com';

        // Update account panel
        function updateAccountPanel(user) {
            const userName = document.getElementById('userName');
            const authButton = document.getElementById('authButton');
            userName.textContent = user ? user.displayName || user.email : '–ì—ñ—Å—Ç—å';
            authButton.textContent = user ? '–í–∏–π—Ç–∏' : '–£–≤—ñ–π—Ç–∏';
            authButton.onclick = user ? signOutUser : () => window.location.href = 'index.html';
            if (!user || user.email !== ADMIN_EMAIL) {
                window.location.href = 'index.html';
            }
        }

        // Sign out user
        window.signOutUser = async () => {
            try {
                await setDoc(doc(db, 'users', auth.currentUser.uid), { lastActivity: new Date().toISOString() }, { merge: true });
                await signOut(auth);
                window.location.href = 'index.html';
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É: ' + error.message);
            }
        };

        // Toggle dark theme
        window.toggleDarkTheme = async () => {
            const isDark = document.body.classList.toggle('dark-theme');
            const toggleIcon = document.querySelector('.theme-toggle i');
            toggleIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            document.querySelector('.theme-toggle').innerHTML = `<i class="${toggleIcon.className}"></i> ${isDark ? '–°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞' : '–¢–µ–º–Ω–∞ —Ç–µ–º–∞'}`;
            localStorage.setItem('darkTheme', isDark);
            if (auth.currentUser) {
                await setDoc(doc(db, 'users', auth.currentUser.uid), { darkTheme: isDark }, { merge: true });
            }
        };

        // User Management
        window.banUser = async () => {
            const email = document.getElementById('banEmail').value.trim();
            const userError = document.getElementById('userError');
            userError.innerHTML = '';
            if (!email) {
                userError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –í–≤–µ–¥—ñ—Ç—å –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É –ø–æ—à—Ç—É';
                return;
            }
            const querySnapshot = await getDocs(query(collection(db, 'users'), where('email', '==', email)));
            if (querySnapshot.empty) {
                userError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
                return;
            }
            const userId = querySnapshot.docs[0].id;
            try {
                await setDoc(doc(db, 'users', userId), { banned: true }, { merge: true });
                userError.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ' + email + ' –∑–∞–±–∞–Ω–µ–Ω–æ';
                document.getElementById('banEmail').value = '';
                showUserActivity();
            } catch (error) {
                userError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        };

        window.unbanUser = async () => {
            const email = document.getElementById('banEmail').value.trim();
            const userError = document.getElementById('userError');
            userError.innerHTML = '';
            if (!email) {
                userError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –í–≤–µ–¥—ñ—Ç—å –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É –ø–æ—à—Ç—É';
                return;
            }
            const querySnapshot = await getDocs(query(collection(db, 'users'), where('email', '==', email)));
            if (querySnapshot.empty) {
                userError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
                return;
            }
            const userId = querySnapshot.docs[0].id;
            try {
                await setDoc(doc(db, 'users', userId), { banned: false }, { merge: true });
                userError.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ' + email + ' —Ä–æ–∑–±–∞–Ω–µ–Ω–æ';
                document.getElementById('banEmail').value = '';
                showUserActivity();
            } catch (error) {
                userError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        };

        window.showUserActivity = async () => {
            const activityDiv = document.getElementById('userActivity');
            activityDiv.innerHTML = '';
            const querySnapshot = await getDocs(collection(db, 'users'));
            querySnapshot.forEach(doc => {
                const user = doc.data();
                const lastActivity = user.lastActivity ? new Date(user.lastActivity).toLocaleString('uk-UA') : '–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö';
                const status = user.banned ? ' (–ó–∞–±–∞–Ω–µ–Ω–æ)' : '';
                activityDiv.innerHTML += `<p><i class="fas fa-user"></i> ${user.nickname || user.email}: ${lastActivity}${status}</p>`;
            });
        };

        // Lesson Management
        window.deleteCommunityLesson = async () => {
            const lessonId = document.getElementById('deleteLessonSelect').value;
            const lessonError = document.getElementById('lessonError');
            lessonError.innerHTML = '';
            if (!lessonId) {
                lessonError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –í–∏–±–µ—Ä—ñ—Ç—å —É—Ä–æ–∫';
                return;
            }
            try {
                const lessonDoc = await getDoc(doc(db, 'communityLessons', lessonId));
                await deleteDoc(doc(db, 'communityLessons', lessonId));
                lessonError.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> –£—Ä–æ–∫ "' + lessonDoc.data().title + '" –≤–∏–¥–∞–ª–µ–Ω–æ';
                updateLessonSelect();
            } catch (error) {
                lessonError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        };

        window.deleteComment = async () => {
            const commentId = document.getElementById('deleteCommentSelect').value;
            const lessonError = document.getElementById('lessonError');
            lessonError.innerHTML = '';
            if (!commentId) {
                lessonError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –í–∏–±–µ—Ä—ñ—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä';
                return;
            }
            const [lessonId, commentKey] = commentId.split(':');
            try {
                const commentDoc = await getDoc(doc(db, 'communityLessons', lessonId, 'comments', commentKey));
                await deleteDoc(doc(db, 'communityLessons', lessonId, 'comments', commentKey));
                lessonError.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> –ö–æ–º–µ–Ω—Ç–∞—Ä "' + commentDoc.data().text.substring(0, 50) + '..." –≤–∏–¥–∞–ª–µ–Ω–æ';
                updateCommentSelect();
            } catch (error) {
                lessonError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        };

        async function updateLessonSelect() {
            const lessonSelect = document.getElementById('deleteLessonSelect');
            lessonSelect.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å —É—Ä–æ–∫</option>';
            const querySnapshot = await getDocs(collection(db, 'communityLessons'));
            querySnapshot.forEach(doc => {
                const lesson = doc.data();
                lessonSelect.innerHTML += `<option value="${doc.id}">${lesson.title} (–ê–≤—Ç–æ—Ä: ${lesson.author})</option>`;
            });
        }

        async function updateCommentSelect() {
            const commentSelect = document.getElementById('deleteCommentSelect');
            commentSelect.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä</option>';
            const querySnapshot = await getDocs(collectionGroup(db, 'comments'));
            querySnapshot.forEach(doc => {
                const comment = doc.data();
                const lessonId = doc.ref.parent.parent.id;
                commentSelect.innerHTML += `<option value="${lessonId}:${doc.id}">${comment.text.substring(0, 50)}... (–ê–≤—Ç–æ—Ä: ${comment.author})</option>`;
            });
        }

        // Quiz Management
        window.openEditQuiz = async () => {
            const quizId = document.getElementById('editQuizSelect').value;
            if (!quizId) {
                document.getElementById('quizError').innerHTML = '<i class="fas fa-exclamation-circle"></i> –í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑';
                return;
            }
            window.location.href = `quizzes.html?editQuizId=${quizId}`;
        };

        window.deleteQuiz = async () => {
            const quizId = document.getElementById('deleteQuizSelect').value;
            const quizError = document.getElementById('quizError');
            quizError.innerHTML = '';
            if (!quizId) {
                quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑';
                return;
            }
            try {
                const docSnap = await getDoc(doc(db, 'communityQuizzes', quizId));
                const batch = writeBatch(db);
                batch.delete(doc(db, 'communityQuizzes', quizId));
                batch.delete(doc(db, 'leaderboard', quizId));
                batch.delete(doc(db, 'reports', quizId));
                const userLikesSnap = await getDocs(collection(db, 'userLikes'));
                userLikesSnap.forEach(doc => {
                    if (doc.data().quizId === quizId) batch.delete(doc.ref);
                });
                await batch.commit();
                quizError.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> –ö–≤—ñ–∑ "' + docSnap.data().title + '" –≤–∏–¥–∞–ª–µ–Ω–æ';
                updateQuizSelect();
                updateReportSelect();
            } catch (error) {
                quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        };

        window.toggleVerifyQuiz = async () => {
            const quizId = document.getElementById('verifyQuizSelect').value;
            const quizError = document.getElementById('quizError');
            quizError.innerHTML = '';
            if (!quizId) {
                quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑';
                return;
            }
            try {
                const docSnap = await getDoc(doc(db, 'communityQuizzes', quizId));
                if (!docSnap.exists()) {
                    quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ö–≤—ñ–∑ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
                    return;
                }
                const quiz = docSnap.data();
                await updateDoc(doc(db, 'communityQuizzes', quizId), { verified: !quiz.verified });
                quizError.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> –ö–≤—ñ–∑ "' + quiz.title + '" ' + (quiz.verified ? '–∑–Ω—è—Ç–æ –∑ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó' : '–≤–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ');
                updateQuizSelect();
            } catch (error) {
                quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        };

        window.showQuizStats = async () => {
            const quizId = document.getElementById('statsQuizSelect').value;
            const quizError = document.getElementById('quizError');
            quizError.innerHTML = '';
            if (!quizId) {
                quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑';
                return;
            }
            try {
                const docSnap = await getDoc(doc(db, 'communityQuizzes', quizId));
                if (!docSnap.exists()) {
                    quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ö–≤—ñ–∑ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
                    return;
                }
                const quiz = docSnap.data();
                const statsDiv = document.getElementById('quizStats');
                statsDiv.innerHTML = '';
                const { totalPlays = 0, totalCorrect = 0, questions, verified = false } = quiz;
                const accuracy = totalPlays > 0 ? ((totalCorrect / (totalPlays * questions.length)) * 100).toFixed(2) : 0;
                statsDiv.innerHTML += `
                    <p><i class="fas fa-info-circle"></i> –ù–∞–∑–≤–∞: ${quiz.title}</p>
                    <p><i class="fas fa-file-alt"></i> –û–ø–∏—Å: ${quiz.description || '–ù–µ–º–∞—î'}</p>
                    <p><i class="fas fa-user"></i> –ê–≤—Ç–æ—Ä: ${quiz.author}</p>
                    <p><i class="fas fa-level-up-alt"></i> –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å: ${quiz.difficulty}</p>
                    <p><i class="fas fa-clock"></i> –ß–∞—Å: ${quiz.timer} —Å–µ–∫</p>
                    <p><i class="fas fa-play-circle"></i> –ü—Ä–æ—Ö–æ–¥–∂–µ–Ω—å: ${totalPlays}</p>
                    <p><i class="fas fa-check"></i> –ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö: ${totalCorrect}</p>
                    <p><i class="fas fa-percentage"></i> –¢–æ—á–Ω—ñ—Å—Ç—å: ${accuracy}%</p>
                    <p><i class="fas fa-thumbs-up"></i> –õ–∞–π–∫–∏: ${quiz.likes || 0}</p>
                    <p><i class="fas fa-thumbs-down"></i> –î–∏–∑–ª–∞–π–∫–∏: ${quiz.dislikes || 0}</p>
                    <p><i class="fas fa-shield-alt"></i> –í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ: ${verified ? '–¢–∞–∫' : '–ù—ñ'}</p>
                `;
                const snap = await getDocs(collection(db, 'leaderboard', quizId, 'scores'));
                if (snap.docs.length) {
                    statsDiv.innerHTML += '<h4><i class="fas fa-crown"></i> –¢–æ–ø-5 –≥—Ä–∞–≤—Ü—ñ–≤</h4><ul>';
                    snap.docs
                        .map(doc => doc.data())
                        .sort((a, b) => b.score - a.score || a.hintsUsed - b.hintsUsed)
                        .slice(0, 5)
                        .forEach(e => {
                            statsDiv.innerHTML += `<li>${e.nickname}: ${e.score} –±–∞–ª—ñ–≤ (–ü—ñ–¥–∫–∞–∑–æ–∫: ${e.hintsUsed})</li>`;
                        });
                    statsDiv.innerHTML += '</ul>';
                }
                // Add chart for statistics
                const chartCanvas = document.createElement('canvas');
                chartCanvas.id = 'quizChart';
                statsDiv.appendChild(chartCanvas);
                const ctx = chartCanvas.getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['–ü—Ä–æ—Ö–æ–¥–∂–µ–Ω—å', '–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π', '–¢–æ—á–Ω—ñ—Å—Ç—å (%)'],
                        datasets: [{
                            data: [totalPlays, totalCorrect, parseFloat(accuracy)],
                            backgroundColor: ['#007bff', '#28a745', '#ffc107']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: document.body.classList.contains('dark-theme') ? '#e0e0e0' : '#1a1a1a'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        };

        window.updateUserScore = async () => {
            const email = document.getElementById('manageScoreEmail').value.trim();
            const quizId = document.getElementById('manageScoreQuizSelect').value;
            const newScore = parseInt(document.getElementById('newScore').value);
            const quizError = document.getElementById('quizError');
            quizError.innerHTML = '';
            if (!email || !quizId || isNaN(newScore)) {
                quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –ø–æ–ª—è';
                return;
            }
            const snap = await getDocs(query(collection(db, 'users'), where('email', '==', email)));
            if (snap.empty) {
                quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ';
                return;
            }
            const userId = snap.docs[0].id;
            const userData = snap.docs[0].data();
            try {
                await setDoc(doc(db, 'leaderboard', quizId, 'scores', userId), {
                    nickname: userData.nickname || email,
                    score: newScore,
                    hintsUsed: 0,
                    questionsAnswered: 0,
                    timestamp: new Date().toISOString()
                });
                quizError.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> –ë–∞–ª –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–æ ' + newScore;
                document.getElementById('manageScoreEmail').value = '';
                document.getElementById('newScore').value = '';
            } catch (error) {
                quizError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        };

        // Report Management
        window.viewReports = async () => {
            const quizId = document.getElementById('reportQuizSelect').value;
            const reportError = document.getElementById('reportError');
            reportError.innerHTML = '';
            if (!quizId) {
                reportError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑';
                return;
            }
            try {
                const snap = await getDocs(query(collection(db, 'reports'), where('quizId', '==', quizId)));
                const reportList = document.getElementById('reportList');
                reportList.innerHTML = snap.empty ? '<p><i class="fas fa-info-circle"></i> –°–∫–∞—Ä–≥ –Ω–µ–º–∞—î</p>' : snap.docs.map(doc => {
                    const report = doc.data();
                    return `
                        <div>
                            <p><i class="fas fa-user"></i> –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: ${report.userEmail}</p>
                            <p><i class="fas fa-exclamation"></i> –ü—Ä–∏—á–∏–Ω–∞: ${report.reason}</p>
                            <p><i class="fas fa-file-alt"></i> –î–µ—Ç–∞–ª—ñ: ${report.details || '–ù–µ–º–∞—î'}</p>
                            <p><i class="fas fa-tags"></i> –°—Ç–∞—Ç—É—Å: ${report.status}</p>
                            <p><i class="fas fa-calendar-alt"></i> –î–∞—Ç–∞: ${new Date(report.timestamp).toLocaleString('uk-UA')}</p>
                            <button onclick="resolveReport('${doc.id}')"><i class="fas fa-check"></i> –í–∏—Ä—ñ—à–∏—Ç–∏</button>
                        </div>`;
                }).join('');
            } catch (error) {
                reportError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        };

        window.resolveReport = async (reportId) => {
            const reportError = document.getElementById('reportError');
            reportError.innerHTML = '';
            try {
                await updateDoc(doc(db, 'reports', reportId), { status: 'resolved' });
                reportError.innerHTML = '<i class="fas fa-check-circle" style="color: green;"></i> –°–∫–∞—Ä–≥—É –≤–∏—Ä—ñ—à–µ–Ω–æ';
                viewReports();
            } catch (error) {
                reportError.innerHTML = '<i class="fas fa-exclamation-circle"></i> –ü–æ–º–∏–ª–∫–∞: ' + error.message;
            }
        };

        async function updateQuizSelect() {
            const snap = await getDocs(collection(db, 'communityQuizzes'));
            ['editQuizSelect', 'deleteQuizSelect', 'statsQuizSelect', 'manageScoreQuizSelect', 'verifyQuizSelect'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑</option>' + snap.docs.map(doc => {
                        const quiz = doc.data();
                        return `<option value="${doc.id}">${quiz.title} (–ê–≤—Ç–æ—Ä: ${quiz.author}${quiz.verified ? ', –í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ' : ''})</option>`;
                    }).join('');
                }
            });
        }

        async function updateReportSelect() {
            const snap = await getDocs(collection(db, 'communityQuizzes'));
            const select = document.getElementById('reportQuizSelect');
            if (select) {
                select.innerHTML = '<option value="">–í–∏–±–µ—Ä—ñ—Ç—å –∫–≤—ñ–∑</option>' + snap.docs.map(doc => {
                    const quiz = doc.data();
                    return `<option value="${doc.id}">${quiz.title} (–ê–≤—Ç–æ—Ä: ${quiz.author}${quiz.verified ? ', –í–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ' : ''})</option>`;
                }).join('');
            }
        }

        // Authentication state handling
        onAuthStateChanged(auth, async user => {
            updateAccountPanel(user);
            if (user) {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                const userData = userDoc.data();
                if (userData && userData.darkTheme) {
                    document.body.classList.add('dark-theme');
                    const toggleIcon = document.querySelector('.theme-toggle i');
                    toggleIcon.className = 'fas fa-sun';
                    document.querySelector('.theme-toggle').innerHTML = `<i class="${toggleIcon.className}"></i> –°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞`;
                }
                showUserActivity();
                updateLessonSelect();
                updateCommentSelect();
                updateQuizSelect();
                updateReportSelect();
            } else {
                window.location.href = 'index.html';
            }
        });

        // Initialize theme
        document.addEventListener('DOMContentLoaded', () => {
            const isDark = localStorage.getItem('darkTheme') === 'true';
            document.body.classList.toggle('dark-theme', isDark);
            const toggleIcon = document.querySelector('.theme-toggle i');
            toggleIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            document.querySelector('.theme-toggle').innerHTML = `<i class="${toggleIcon.className}"></i> ${isDark ? '–°–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞' : '–¢–µ–º–Ω–∞ —Ç–µ–º–∞'}`;
        });
    </script>
</body>
</html>
