<!DOCTYPE html>
<html lang="uk">
<meta charset="UTF-8">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–£—Ä–æ–∫–∏ –±—ñ–æ–ª–æ–≥—ñ—ó</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon-for-app.png">

  <!-- PWA –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ -->
  <meta name="theme-color" content="#317EFB" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- –®—Ä–∏—Ñ—Ç–∏ -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">

  <!-- SEO -->
  <meta name="description" content="BIOWORLD ‚Äî —Å–∞–π—Ç, –¥–µ –±—ñ–æ–ª–æ–≥—ñ—è —Å—Ç–∞—î —Ü—ñ–∫–∞–≤–æ—é! –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ –∫–ª—ñ—Ç–∏–Ω–∏, –î–ù–ö, –≤—ñ—Ä—É—Å–∏, —Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑ —ñ –≤—Å–µ, —â–æ —Ç—Ä–µ–±–∞ –∑–Ω–∞—Ç–∏. –ë–µ–∑ –Ω—É–¥—å–≥–∏, –∑ –≥—É–º–æ—Ä–æ–º —ñ –ª—é–±–æ–≤‚Äô—é –¥–æ –Ω–∞—É–∫–∏!">
  <meta name="keywords" content="–±—ñ–æ–ª–æ–≥—ñ—è, –∫–ª—ñ—Ç–∏–Ω–∞, —Ç–≤–∞—Ä–∏–Ω–∞, —ñ–≥—Ä–∏, —à–∫—ñ–ª—å–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞, BioWord, —Ä–æ—Å–ª–∏–Ω–∏, BIOWORLD">
  <meta name="author" content="BroPetro">

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js';
    import { getDatabase, ref, set, get, update, onValue } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js';

    // Firebase –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
    const firebaseConfig = {
      apiKey: "AIzaSyDLJGPbMVGY-5b-aRbFlqgYSqn9c8azZ_E",
      authDomain: "bioworld-1.firebaseapp.com",
      databaseURL: "https://bioworld-1-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bioworld-1",
      storageBucket: "bioworld-1.firebasestorage.app",
      messagingSenderId: "691211086040",
      appId: "1:691211086040:web:3c7a15ca8abf2742788fad",
      measurementId: "G-YPD46XPR20"
    };

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    // –ï–∫—Å–ø–æ—Ä—Ç –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É —Å–∫—Ä–∏–ø—Ç—ñ
    window.auth = auth;
    window.database = database;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.signOut = signOut;
    window.onAuthStateChanged = onAuthStateChanged;
    window.updateProfile = updateProfile;
    window.ref = ref;
    window.set = set;
    window.get = get;
    window.update = update;
    window.onValue = onValue;
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').then(reg => {
          console.log('‚úÖ Service Worker –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ:', reg.scope);
        }).catch(err => {
          console.log('‚ùå –ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó Service Worker:', err);
        });
      });
    }
  </script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #4caf50);
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow-x: hidden;
      padding-top: 70px;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      width: 90%;
      max-width: 800px;
      text-align: center;
      margin: 20px;
      animation: fadeIn 1s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      font-family: 'Roboto Mono', monospace;
      color: #2e7d32;
      font-size: 2em;
      margin-bottom: 15px;
    }

    p {
      font-size: 1em;
      color: #555;
      margin-bottom: 20px;
    }

    .xp-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      width: 100%;
      max-width: 800px;
      margin-top: 15px;
    }

    .xp-container {
      background: linear-gradient(45deg, #81c784, #4caf50);
      padding: 15px;
      border-radius: 15px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      text-align: center;
    }

    .xp-container:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .button {
      display: inline-block;
      background: linear-gradient(45deg, #2e7d32, #4caf50);
      color: white;
      padding: 12px 25px;
      text-decoration: none;
      font-size: 1em;
      border-radius: 50px;
      margin: 8px;
      transition: all 0.3s ease;
      min-width: 120px;
      text-align: center;
      min-height: 44px;
    }

    .button:hover {
      background: linear-gradient(45deg, #4caf50, #2e7d32);
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
    }

    .settings-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, #ffffff, #e6f3e6);
      padding: 25px;
      border-radius: 25px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      display: none;
      text-align: left;
      z-index: 1000;
      width: 90%;
      max-width: 450px;
      max-height: 80vh;
      overflow-y: auto;
      border: 2px solid #2e7d32;
    }

    .settings-popup h2 {
      color: #2e7d32;
      margin-bottom: 20px;
      font-size: 1.6em;
      font-family: 'Roboto Mono', monospace;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .settings-popup label {
      display: flex;
      align-items: center;
      font-size: 1em;
      color: #333;
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(46, 125, 50, 0.05);
      border-radius: 10px;
      transition: background 0.3s ease;
    }

    .settings-popup label:hover {
      background: rgba(46, 125, 50, 0.1);
    }

    .settings-popup input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      accent-color: #2e7d32;
    }

    .settings-popup input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1px solid #2e7d32;
      border-radius: 8px;
      font-size: 0.95em;
      background: #f9f9f9;
      transition: border-color 0.3s ease;
    }

    .settings-popup input[type="text"]:focus {
      border-color: #1b5e20;
      outline: none;
    }

    .settings-popup select {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1px solid #2e7d32;
      border-radius: 8px;
      font-size: 0.95em;
      background: #f9f9f9;
      transition: border-color 0.3s ease;
      cursor: pointer;
    }

    .settings-popup select:focus {
      border-color: #1b5e20;
      outline: none;
    }

    .settings-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    .settings-popup button, .close-btn {
      background: linear-gradient(45deg, #2e7d32, #4caf50);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95em;
      transition: background 0.3s ease, transform 0.2s ease;
      min-height: 44px;
    }

    .settings-popup button:hover, .close-btn:hover {
      background: linear-gradient(45deg, #4caf50, #2e7d32);
      transform: translateY(-2px);
    }

    .close-btn {
      background: linear-gradient(45deg, #d32f2f, #b71c1c);
    }

    .close-btn:hover {
      background: linear-gradient(45deg, #b71c1c, #d32f2f);
    }

    .easter-greeting {
      position: fixed;
      bottom: 15px;
      right: 15px;
      background: rgba(255, 245, 157, 0.9);
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      color: #2e7d32;
      font-weight: bold;
      z-index: 1000;
      font-size: 0.9em;
      max-width: 80%;
    }

    .easter-greeting a {
      color: #1b5e20;
      text-decoration: underline;
    }

    .account-btn {
      position: fixed;
      top: 15px;
      right: 15px;
      background: #2e7d32;
      color: white;
      padding: 10px 15px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s ease;
      font-size: 0.9em;
    }

    .account-btn:hover {
      background: #1b5e20;
    }

    .popup {
      display: none;
      position: fixed;
      top: 80px;
      right: 15px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      width: 90%;
      max-width: 350px;
      z-index: 1000;
      color: #333;
      max-height: 70vh;
      overflow-y: auto;
    }

    .popup input[type="text"],
    .popup input[type="password"],
    .popup input[type="email"],
    .popup input[type="file"] {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 0.9em;
    }

    .popup button {
      width: 100%;
      background: #2e7d32;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 8px 0;
      transition: background 0.3s ease;
      font-size: 0.9em;
      min-height: 44px;
    }

    .popup button:hover {
      background: #1b5e20;
    }

    .popup img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 10px;
    }

    .welcome-banner {
      position: fixed;
      top: 0;
      width: 100%;
      background: #ffca28;
      color: #2e7d32;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: none;
      font-size: 0.9em;
    }

    .xp-progress-container {
      margin-top: 10px;
      text-align: left;
    }

    .xp-progress-bar {
      width: 100%;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 5px;
      height: 15px;
      overflow: hidden;
    }

    .xp-progress {
      height: 100%;
      background: #2e7d32;
      transition: width 0.5s ease-in-out;
    }

    .xp-level {
      font-size: 0.9em;
      color: #2e7d32;
      margin-top: 8px;
    }

    .promo-history, .achievements {
      margin-top: 15px;
      text-align: left;
    }

    .promo-history h3, .achievements h3 {
      color: #2e7d32;
      font-size: 1.1em;
      margin-bottom: 10px;
    }

    .promo-history ul, .achievements ul {
      list-style: none;
      padding: 0;
    }

    .promo-history li, .achievements li {
      padding: 5px 0;
      font-size: 0.9em;
      color: #555;
      line-height: 1.4;
      pointer-events: all;
    }

    .achievements li span.emoji {
      font-size: 1.2em;
      margin-right: 8px;
      display: inline-block;
      vertical-align: middle;
    }

    .achievements li span.achievement-details {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .achievements li:hover span.achievement-details {
      opacity: 1;
    }

    .achievements li sup {
      font-size: 0.7em;
      color: #2e7d32;
      vertical-align: super;
      margin-left: 4px;
    }

    .share-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      display: none;
      text-align: center;
      z-index: 1000;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .share-popup h3 {
      color: #2e7d32;
      margin-bottom: 15px;
      font-size: 1.3em;
    }

    .share-popup button {
      width: 100%;
      background: #1b5e20;
      color: white;
      padding: 10px;
      margin: 8px 0;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.3s ease;
      min-height: 44px;
    }

    .share-popup button:hover {
      background: #2e7d32;
    }

    .notification-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      display: none;
      text-align: center;
      z-index: 1001;
      width: 90%;
      max-width: 400px;
      animation: slideIn 0.3s ease-in-out;
    }

    .notification-popup p {
      color: #2e7d32;
      font-size: 1em;
      margin-bottom: 15px;
    }

    .notification-popup button {
      background: linear-gradient(45deg, #2e7d32, #4caf50);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95em;
      transition: background 0.3s ease;
    }

    .notification-popup button:hover {
      background: linear-gradient(45deg, #4caf50, #2e7d32);
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translate(-50%, -60%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }

    @media (max-width: 768px) {
      body {
        padding-top: 60px;
        font-size: 16px;
      }

      .container {
        padding: 15px;
        margin: 10px;
        width: 95%;
      }

      h1 {
        font-size: 1.8em;
      }

      p {
        font-size: 0.9em;
      }

      .xp-wrapper {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .xp-container {
        padding: 12px;
        font-size: 0.9em;
      }

      .button {
        padding: 10px 20px;
        font-size: 0.9em;
        min-height: 44px;
        margin: 5px;
      }

      .settings-popup, .share-popup, .notification-popup {
        width: 95%;
        padding: 15px;
        max-height: 85vh;
      }

      .settings-popup h2, .share-popup h3, .notification-popup p {
        font-size: 1.3em;
      }

      .account-btn {
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 0.85em;
      }

      .popup {
        top: 60px;
        right: 10px;
        width: 95%;
        padding: 12px;
        max-height: 75vh;
      }

      .popup img {
        width: 60px;
        height: 60px;
      }

      .easter-greeting {
        bottom: 10px;
        right: 10px;
        padding: 8px 15px;
        font-size: 0.8em;
        max-width: 90%;
      }

      .welcome-banner {
        font-size: 0.85em;
        padding: 8px;
      }

      .xp-progress-bar {
        height: 12px;
      }

      .xp-level {
        font-size: 0.85em;
      }

      .promo-history h3, .achievements h3 {
        font-size: 1em;
      }

      .promo-history li, .achievements li {
        font-size: 0.85em;
        line-height: 1.3;
      }

      .achievements li span.emoji {
        font-size: 1.1em;
      }

      .achievements li sup {
        font-size: 0.65em;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.5em;
      }

      p {
        font-size: 0.85em;
      }

      .button {
        font-size: 0.85em;
        padding: 8px 15px;
        min-height: 40px;
      }

      .settings-popup, .share-popup, .notification-popup {
        padding: 10px;
      }

      .popup {
        padding: 10px;
      }

      .account-btn {
        padding: 6px 10px;
        font-size: 0.8em;
      }

      .easter-greeting {
        font-size: 0.75em;
      }

      .achievements li span.emoji {
        font-size: 1em;
      }

      .achievements li sup {
        font-size: 0.6em;
      }
    }

    #update-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(30,30,30,0.95);
      color: #fff;
      font-family: sans-serif;
      font-size: 1.2em;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #ccc;
      border-top-color: #00ffcc;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="welcome-banner" id="welcomeBanner">
    üéâ –í—ñ—Ç–∞—î–º–æ –Ω–∞ BioWorld! –¢–∏ –≥–æ—Ç–æ–≤–∏–π –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ –±—ñ–æ–ª–æ–≥—ñ—é?
  </div>

  <button class="account-btn" onclick="togglePopup()">üë§ –ê–∫–∞—É–Ω—Ç</button>

  <div class="popup" id="accountPopup">
    <div id="accountForm">
      <input type="text" id="usernameInput" placeholder="–í–∞—à–µ —ñ–º'—è">
      <input type="email" id="emailInput" placeholder="–ï–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞ –ø–æ—à—Ç–∞">
      <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
      <input type="file" id="avatarInput" accept="image/*">
      <button onclick="registerAccount()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
      <button onclick="loginAccount()">–£–≤—ñ–π—Ç–∏</button>
    </div>
    <div id="accountInfo" style="display:none;">
      <img id="userAvatar" src="" alt="–ê–≤–∞—Ç–∞—Ä–∫–∞">
      <p>üëã –ü—Ä–∏–≤—ñ—Ç, <span id="displayName"></span>!</p>
      <p id="timeGreeting"></p>
      <p>üìä –í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω—å: <span id="visitCount"></span></p>
      <div id="chartContainer">
        <canvas id="loginChart"></canvas>
      </div>
      <div class="xp-progress-container">
        <p>–í–∞—à XP: <span id="xp-points-account">0</span> / 200</p>
        <div class="xp-progress-bar">
          <div class="xp-progress" id="xp-progress" style="width: 0%;"></div>
        </div>
        <p class="xp-level">–†—ñ–≤–µ–Ω—å: <span id="xp-level">1</span></p>
      </div>
      <input type="text" id="promoCodeInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥">
      <button onclick="applyPromoCode()">–ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥</button>
      <button onclick="openSharePopup()">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º</button>
      <button onclick="installApp()">–í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫</button>
      <div class="promo-history">
        <h3>–Ü—Å—Ç–æ—Ä—ñ—è –ø—Ä–æ–º–æ–∫–æ–¥—ñ–≤</h3>
        <ul id="promoHistoryList"></ul>
      </div>
      <div class="achievements">
        <h3>üèÜ –î–æ—Å—è–≥–Ω–µ–Ω–Ω—è</h3>
        <ul id="achievementsList"></ul>
      </div>
      <button onclick="logout()">–í–∏–π—Ç–∏</button>
      <button onclick="editProfile()">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å</button>
      <button onclick="changeAvatar()">–ó–º—ñ–Ω–∏—Ç–∏ –∞–≤–∞—Ç–∞—Ä–∫—É</button>
      <button onclick="claimBonus()">–û—Ç—Ä–∏–º–∞—Ç–∏ –±–æ–Ω—É—Å</button>
    </div>
  </div>

  <div class="share-popup" id="sharePopup">
    <h3>–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º</h3>
    <p>–ó–∞–ø—Ä–æ—Å–∏ –¥—Ä—É–≥–∞ —Ç–∞ –æ—Ç—Ä–∏–º–∞–π –¥–æ 40 XP!</p>
    <button onclick="shareViaTelegram()">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è —á–µ—Ä–µ–∑ Telegram</button>
    <button onclick="shareViaViber()">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è —á–µ—Ä–µ–∑ Viber</button>
    <button onclick="shareViaWhatsApp()">–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è —á–µ—Ä–µ–∑ WhatsApp</button>
    <button onclick="copyShareLink()">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</button>
    <div class="close-btn" onclick="closeSharePopup()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</div>
  </div>

  <div class="notification-popup" id="notificationPopup">
    <p id="notificationMessage"></p>
    <button onclick="closeNotification()">OK</button>
  </div>

  <div class="container">
    <h1>üìö –£—Ä–æ–∫–∏ –∑ –±—ñ–æ–ª–æ–≥—ñ—ó</h1>
    <p>–î–æ—Å–ª—ñ–¥–∂—É–π —Å–≤—ñ—Ç –ø—Ä–∏—Ä–æ–¥–∏ —Ä–∞–∑–æ–º —ñ–∑ –Ω–∞–º–∏!</p>
    <a href="Lesson/LessIndex.html" class="button">üìñ –ü–µ—Ä–µ–π—Ç–∏ –¥–æ —É—Ä–æ–∫—ñ–≤</a>
    <a href="QUZ.html" class="button">üß™ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</a><br>
    <a href="Nots.html" class="button">üóíÔ∏è –ù–æ—Ç–∞—Ç–Ω–∏–∫</a>
    <a href="Forum.html" class="button">üí¨ –§–æ—Ä—É–º</a><br>
    <a href="InfoCrator.html" class="button">üè† –ü—Ä–æ –Ω–∞—Å</a>
    <a href="InfoUpdate.html" class="button">–û–Ω–æ–≤–ª–µ–Ω–Ω—è</a>
    <a href="#" class="button" onclick="openSettings()">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</a>
  </div>

  <div class="xp-wrapper">
    <div class="xp-container" onclick="location.href='prizes.html'">
      –í–∞—à XP: <span id="xp-points">0</span>
      <div class="xp-progress-container">
        <div class="xp-progress-bar">
          <div class="xp-progress" id="xp-progress-main" style="width: 0%;"></div>
        </div>
        <p class="xp-level">–†—ñ–≤–µ–Ω—å: <span id="xp-level-main">1</span></p>
      </div>
    </div>
    <div class="xp-container" onclick="redirectToRandomTest()">
      üé≤ –í–∏–ø—Ä–æ–±—É–π —Å–µ–±–µ!
    </div>
    <div class="xp-container" onclick="location.href='Test.html'">
      üåø –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞—á –†–æ—Å–ª–∏–Ω
    </div>
  </div>

  <div class="settings-popup" id="settings">
    <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
    <label>
      üé® –í–∏–±—Ä–∞—Ç–∏ —Ç–µ–º—É:
      <select id="themeSelect">
        <option value="default">–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º (–õ—ñ—Å–æ–≤–∞ –∑–µ–ª–µ–Ω—å)</option>
        <option value="ocean">–û–∫–µ–∞–Ω—Å—å–∫–∞ –±–ª–∞–∫–∏—Ç—å</option>
        <option value="sunset">–ó–∞—Ö—ñ–¥ —Å–æ–Ω—Ü—è</option>
        <option value="dark">–¢–µ–º–Ω–∞ —Ç–µ–º–∞</option>
      </select>
    </label>
    <label>
      <input type="checkbox" id="animationToggle" checked> ‚ú® –ê–Ω—ñ–º–∞—Ü—ñ—ó
    </label>
    <label>
      üñº –í–ª–∞—Å–Ω–∏–π —Ñ–æ–Ω:
      <input type="text" id="bgInput" placeholder="–í—Å—Ç–∞–≤—Ç–µ URL">
    </label>
    <div class="settings-buttons">
      <button onclick="applySettings()">‚úÖ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <div class="close-btn" onclick="closeSettings()">‚ùå –ó–∞–∫—Ä–∏—Ç–∏</div>
    </div>
  </div>

  <div class="easter-greeting">
    <button class="close-btn" onclick="this.parentElement.style.display='none';">‚úñ</button>
    üå≥üå≥ –ì–∞—Ä–Ω–∏—Ö –∫–∞–Ω—ñ–∫—É–ª üå≥üå≥<br>
    <a href="https://tally.so/r/woZjy5">–ü—Ä–æ–π–¥–∏ –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è –±—É–¥—å –ª–∞—Å–∫–∞</a>
  </div>
  <div id="update-loader" style="display: none;">
    <div class="spinner"></div>
    <p>–û–Ω–æ–≤–ª—é—î–º–æ... –∑–∞—á–µ–∫–∞–π —Ç—Ä–æ—Ö–∏ üîÑ</p>
  </div>

  <script>
    let xpPoints = parseInt(localStorage.getItem('xpPoints') || 0);
    const maxXP = 200;
    let lastClaimDate = localStorage.getItem('lastClaimDate') || '';
    const today = new Date().toISOString().split('T')[0];

    // Pre-defined promo codes for invites
    const promoCodes = {
      'xp20': { reward: 20, type: 'xp', expires: '2025-12-31', maxUses: 1 },
      'xp40': { reward: 40, type: 'xp', expires: '2025-12-31', maxUses: 1 },
      'badge1': { reward: 'Plant Expert Badge', type: 'badge', expires: '2025-12-31', maxUses: 1 },
      'lesson1': { reward: 'Unlock Exclusive Lesson', type: 'lesson', expires: '2025-12-31', maxUses: 1 },
      'invite1': { reward: 25, type: 'xp', expires: '2025-12-31', maxUses: 5 },
      'invite2': { reward: 30, type: 'xp', expires: '2025-12-31', maxUses: 5 },
      'invite3': { reward: 35, type: 'xp', expires: '2025-12-31', maxUses: 5 },
      'invite4': { reward: 28, type: 'xp', expires: '2025-12-31', maxUses: 5 },
      'invite5': { reward: 40, type: 'xp', expires: '2025-12-31', maxUses: 5 }
    };

    // Achievement emojis
    const achievementEmojis = {
      '–¢–∏ —â–æ, –≥–µ–Ω—ñ–π?': 'üèÜ',
      '–ú–∞–π—Å—Ç–µ—Ä –±—ñ–æ–ª–æ–≥—ñ—ó': 'üåü',
      '–ú–µ–≥–∞ –º–æ–∑–æ–∫!': 'üöÄ',
      '–©–æ–¥–µ–Ω–Ω–∏–π –≤—Ö—ñ–¥': 'üìÖ',
      '–ê–∫—Ç–∏–≤–∞—Ü—ñ—è –ø—Ä–æ–º–æ–∫–æ–¥—É': 'üéÅ',
      '–û—Ç—Ä–∏–º–∞–Ω–Ω—è –±–æ–Ω—É—Å—É': 'üí∞',
      '–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –¥—Ä—É–≥–∞': 'ü§ù',
      '–í–∏–ø–∞–¥–∫–æ–≤–∏–π —Ç–µ—Å—Ç': 'üé≤',
      '–ó–º—ñ–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å': '‚öôÔ∏è',
      '–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É': 'üì±',
      '–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∞–∫–∞—É–Ω—Ç—É': 'üë§',
      '–í—Ö—ñ–¥ –¥–æ –∞–∫–∞—É–Ω—Ç—É': 'üîë',
      '–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é': '‚úèÔ∏è',
      '–ó–º—ñ–Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏': 'üñºÔ∏è'
    };

    // Theme configurations
    const themes = {
      default: {
        background: 'linear-gradient(135deg, #e0f7fa, #4caf50)',
        textColor: '#333',
        buttonGradient: 'linear-gradient(45deg, #2e7d32, #4caf50)',
        buttonHoverGradient: 'linear-gradient(45deg, #4caf50, #2e7d32)'
      },
      ocean: {
        background: 'linear-gradient(135deg, #a1c4fd, #2196f3)',
        textColor: '#1e3a8a',
        buttonGradient: 'linear-gradient(45deg, #1565c0, #42a5f5)',
        buttonHoverGradient: 'linear-gradient(45deg, #42a5f5, #1565c0)'
      },
      sunset: {
        background: 'linear-gradient(135deg, #ffccbc, #f57c00)',
        textColor: '#4a2c00',
        buttonGradient: 'linear-gradient(45deg, #d84315, #ff9800)',
        buttonHoverGradient: 'linear-gradient(45deg, #ff9800, #d84315)'
      },
      dark: {
        background: '#121212',
        textColor: '#e0e0e0',
        buttonGradient: 'linear-gradient(45deg, #424242, #757575)',
        buttonHoverGradient: 'linear-gradient(45deg, #757575, #424242)'
      }
    };

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–ø–ª–∏–≤–∞—é—á–∏—Ö –≤—ñ–∫–æ–Ω
    function showNotification(message) {
      const popup = document.getElementById('notificationPopup');
      const messageElement = document.getElementById('notificationMessage');
      messageElement.textContent = message;
      popup.style.display = 'block';
      setTimeout(() => {
        popup.style.display = 'none';
      }, 3000);
    }

    function closeNotification() {
      document.getElementById('notificationPopup').style.display = 'none';
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
    function compressImage(file, callback) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const maxWidth = 100;
          const maxHeight = 100;
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > maxWidth) {
              height = Math.round((height * maxWidth) / width);
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width = Math.round((width * maxHeight) / height);
              height = maxHeight;
            }
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          const compressedUrl = canvas.toDataURL('image/jpeg', 0.7);
          callback(compressedUrl);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function syncUserData(userData) {
      if (!userData) return;
      localStorage.setItem('bioUsername', userData.username || '');
      localStorage.setItem('bioAvatar', userData.avatar || '');
      localStorage.setItem('bioVisits', userData.visits || 1);
      localStorage.setItem('xpPoints', userData.xpPoints || 0);
      localStorage.setItem('userAchievements', JSON.stringify(userData.achievements || []));
      localStorage.setItem('promoHistory', JSON.stringify(userData.promoHistory || []));
      localStorage.setItem('usedPromoCodes', JSON.stringify(userData.usedPromoCodes || []));
      localStorage.setItem('userBadges', JSON.stringify(userData.userBadges || []));
      localStorage.setItem('unlockedLessons', JSON.stringify(userData.unlockedLessons || []));
      localStorage.setItem('loginHistory', JSON.stringify(userData.loginHistory || {}));
      localStorage.setItem('theme', userData.theme || 'default');
      localStorage.setItem('customBg', userData.customBg || '');
      localStorage.setItem('animations', userData.animations !== undefined ? userData.animations : true);

      xpPoints = userData.xpPoints || 0;
      showAccountInfo(userData.username, userData.avatar, userData.visits);
      updateXPProgress();
      updatePromoHistory();
      updateAchievements();
      applyTheme(userData.theme, userData.customBg, userData.animations);
    }

    function updateXPProgress() {
      const progressPercent = (xpPoints / maxXP) * 100;
      document.getElementById('xp-progress').style.width = `${progressPercent}%`;
      document.getElementById('xp-progress-main').style.width = `${progressPercent}%`;
      document.getElementById('xp-points').textContent = xpPoints;
      document.getElementById('xp-points-account').textContent = xpPoints;

      const level = Math.floor(xpPoints / 50) + 1;
      document.getElementById('xp-level').textContent = level;
      document.getElementById('xp-level-main').textContent = level;

      if (xpPoints >= maxXP) {
        xpPoints = 0;
        localStorage.setItem('xpPoints', xpPoints);
        const user = auth.currentUser;
        if (user) {
          update(ref(database, 'users/' + user.uid), { xpPoints: xpPoints });
        }
        showNotification('–í—ñ—Ç–∞—î–º–æ! –í–∏ –¥–æ—Å—è–≥–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è! XP —Å–∫–∏–Ω—É—Ç–æ.');
      }
    }

    function updateAchievements() {
      const achievements = JSON.parse(localStorage.getItem('userAchievements') || '[]');
      const achievementsList = document.getElementById('achievementsList');
      achievementsList.innerHTML = '';

      if (achievements.length === 0) {
        const li = document.createElement('li');
        li.textContent = '–©–µ –Ω–µ–º–∞—î –¥–æ—Å—è–≥–Ω–µ–Ω—å. –û—Ç—Ä–∏–º–∞–π—Ç–µ —ó—Ö —É —Ä–æ–∑–¥—ñ–ª—ñ "–î–æ—Å—è–≥–Ω–µ–Ω–Ω—è —Ç–∞ –ü—Ä–∏–∑–∏"!';
        achievementsList.appendChild(li);
        return;
      }

      const aggregated = {};
      achievements.forEach(achievement => {
        if (!aggregated[achievement.name]) {
          aggregated[achievement.name] = { count: 0, date: achievement.date };
        }
        aggregated[achievement.name].count += 1;
        if (new Date(achievement.date) > new Date(aggregated[achievement.name].date)) {
          aggregated[achievement.name].date = achievement.date;
        }
      });

      Object.keys(aggregated).forEach(name => {
        const { count, date } = aggregated[name];
        const emoji = achievementEmojis[name] || 'üèÖ';
        const li = document.createElement('li');
        const multiplier = count > 1 ? `<sup>x${count}</sup>` : '';
        li.innerHTML = `<span class="emoji">${emoji}</span>${name} <span class="achievement-details">(${date})${multiplier}</span>`;
        achievementsList.appendChild(li);
      });
    }

    function addAchievement(name) {
      const achievements = JSON.parse(localStorage.getItem('userAchievements') || '[]');
      const today = new Date().toISOString().split('T')[0];
      achievements.push({ name: name, date: today });
      localStorage.setItem('userAchievements', JSON.stringify(achievements));
      const user = auth.currentUser;
      if (user) {
        update(ref(database, 'users/' + user.uid), { achievements: achievements });
      }
      updateAchievements();
    }

    function applyTheme(theme, customBg, animations) {
      if (theme !== 'custom' && themes[theme]) {
        const selectedTheme = themes[theme];
        document.body.style.background = selectedTheme.background;
        document.body.style.color = selectedTheme.textColor;
        document.querySelectorAll('.button, .settings-popup button, .close-btn:not(.close-btn), .account-btn').forEach(btn => {
          btn.style.background = selectedTheme.buttonGradient;
          btn.onmouseover = () => btn.style.background = selectedTheme.buttonHoverGradient;
          btn.onmouseout = () => btn.style.background = selectedTheme.buttonGradient;
        });
        document.querySelectorAll('.xp-container').forEach(container => {
          container.style.background = selectedTheme.buttonGradient;
        });
      }

      if (customBg) {
        document.body.style.background = `url('${customBg}') no-repeat center center/cover`;
      }

      document.body.style.transition = animations ? 'background 0.5s ease-in-out' : 'none';
      document.getElementById('themeSelect').value = theme;
      document.getElementById('bgInput').value = customBg || '';
      document.getElementById('animationToggle').checked = animations;
    }

    if (lastClaimDate !== today) {
      xpPoints += 50;
      localStorage.setItem('xpPoints', xpPoints);
      const user = auth.currentUser;
      if (user) {
        update(ref(database, 'users/' + user.uid), { xpPoints: xpPoints });
        addAchievement('–©–æ–¥–µ–Ω–Ω–∏–π –≤—Ö—ñ–¥');
      }
      localStorage.setItem('lastClaimDate', today);
      showNotification('–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 50 XP –∑–∞ —â–æ–¥–µ–Ω–Ω–∏–π –≤—Ö—ñ–¥!');
      updateXPProgress();
    }

    function claimBonus() {
      if (xpPoints >= 100) {
        xpPoints += 20;
        localStorage.setItem('xpPoints', xpPoints);
        const user = auth.currentUser;
        if (user) {
          update(ref(database, 'users/' + user.uid), { xpPoints: xpPoints });
          addAchievement('–û—Ç—Ä–∏–º–∞–Ω–Ω—è –±–æ–Ω—É—Å—É');
        }
        showNotification('–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –±–æ–Ω—É—Å 20 XP!');
        updateXPProgress();
      } else {
        showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ XP –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –±–æ–Ω—É—Å—É! –ü–æ—Ç—Ä—ñ–±–Ω–æ 100 XP.');
      }
    }

    function applyPromoCode() {
      const promoCode = document.getElementById('promoCodeInput').value.trim().toLowerCase();
      const usedPromoCodes = JSON.parse(localStorage.getItem('usedPromoCodes') || '[]');
      const promoHistory = JSON.parse(localStorage.getItem('promoHistory') || '[]');

      if (usedPromoCodes.includes(promoCode)) {
        showNotification('–¶–µ–π –ø—Ä–æ–º–æ–∫–æ–¥ —É–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ!');
        return;
      }

      if (promoCodes[promoCode]) {
        const { reward, type, expires, maxUses } = promoCodes[promoCode];
        const currentDate = new Date().toISOString().split('T')[0];

        if (currentDate > expires) {
          showNotification('–¢–µ—Ä–º—ñ–Ω –¥—ñ—ó –ø—Ä–æ–º–æ–∫–æ–¥—É –º–∏–Ω—É–≤!');
          return;
        }

        if (type === 'xp') {
          xpPoints += reward;
          localStorage.setItem('xpPoints', xpPoints);
          showNotification(`–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! –í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ ${reward} XP!`);
          updateXPProgress();
          addAchievement('–ê–∫—Ç–∏–≤–∞—Ü—ñ—è –ø—Ä–æ–º–æ–∫–æ–¥—É');
        } else if (type === 'badge') {
          const userBadges = JSON.parse(localStorage.getItem('userBadges') || '[]');
          userBadges.push(reward);
          localStorage.setItem('userBadges', JSON.stringify(userBadges));
          showNotification(`–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! –í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ –∑–Ω–∞—á–æ–∫: ${reward}!`);
          addAchievement('–û—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–Ω–∞—á–∫–∞');
        } else if (type === 'lesson') {
          const unlockedLessons = JSON.parse(localStorage.getItem('unlockedLessons') || '[]');
          unlockedLessons.push(reward);
          localStorage.setItem('unlockedLessons', JSON.stringify(unlockedLessons));
          showNotification(`–ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! –í–∏ —Ä–æ–∑–±–ª–æ–∫—É–≤–∞–ª–∏: ${reward}!`);
          addAchievement('–†–æ–∑–±–ª–æ–∫—É–≤–∞–Ω–Ω—è —É—Ä–æ–∫—É');
        }

        usedPromoCodes.push(promoCode);
        localStorage.setItem('usedPromoCodes', JSON.stringify(usedPromoCodes));
        promoHistory.push({ code: promoCode, reward: reward, date: currentDate });
        localStorage.setItem('promoHistory', JSON.stringify(promoHistory));

        const user = auth.currentUser;
        if (user) {
          update(ref(database, 'users/' + user.uid), {
            xpPoints: xpPoints,
            userBadges: JSON.parse(localStorage.getItem('userBadges') || '[]'),
            unlockedLessons: JSON.parse(localStorage.getItem('unlockedLessons') || '[]'),
            usedPromoCodes: usedPromoCodes,
            promoHistory: promoHistory,
            achievements: JSON.parse(localStorage.getItem('userAchievements') || '[]')
          });
        }

        updatePromoHistory();
      } else {
        showNotification('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø—Ä–æ–º–æ–∫–æ–¥!');
      }
      document.getElementById('promoCodeInput').value = '';
    }

    function updatePromoHistory() {
      const promoHistory = JSON.parse(localStorage.getItem('promoHistory') || '[]');
      const promoHistoryList = document.getElementById('promoHistoryList');
      promoHistoryList.innerHTML = '';
      promoHistory.forEach(entry => {
        const li = document.createElement('li');
        li.textContent = `${entry.date}: ${entry.code} - ${entry.reward}`;
        promoHistoryList.appendChild(li);
      });
    }

    function openSharePopup() {
      document.getElementById('sharePopup').style.display = 'block';
    }

    function closeSharePopup() {
      document.getElementById('sharePopup').style.display = 'none';
    }

    function shareViaTelegram() {
      const promoCode = getRandomInviteCode();
      const shareText = `–ü—Ä–∏—î–¥–Ω—É–π—Å—è –¥–æ BioWorld —Ç–∞ –¥—ñ–∑–Ω–∞–π—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ –±—ñ–æ–ª–æ–≥—ñ—é! –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π –ø—Ä–æ–º–æ–∫–æ–¥ ${promoCode} –¥–ª—è –±–æ–Ω—É—Å—É! üåøüî¨ ${window.location.href}?code=${promoCode}`;
      const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(shareText)}`;
      window.open(telegramUrl, '_blank');
      trackSharedCode(promoCode);
      closeSharePopup();
    }

    function shareViaViber() {
      const promoCode = getRandomInviteCode();
      const shareText = `–ü—Ä–∏—î–¥–Ω—É–π—Å—è –¥–æ BioWorld —Ç–∞ –¥—ñ–∑–Ω–∞–π—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ –±—ñ–æ–ª–æ–≥—ñ—é! –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π –ø—Ä–æ–º–æ–∫–æ–¥ ${promoCode} –¥–ª—è –±–æ–Ω—É—Å—É! üåøüî¨ ${window.location.href}?code=${promoCode}`;
      const viberUrl = `viber://forward?text=${encodeURIComponent(shareText)}`;
      window.open(viberUrl, '_blank');
      trackSharedCode(promoCode);
      closeSharePopup();
    }

    function shareViaWhatsApp() {
      const promoCode = getRandomInviteCode();
      const shareText = `–ü—Ä–∏—î–¥–Ω—É–π—Å—è –¥–æ BioWorld —Ç–∞ –¥—ñ–∑–Ω–∞–π—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ –±—ñ–æ–ª–æ–≥—ñ—é! –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π –ø—Ä–æ–º–æ–∫–æ–¥ ${promoCode} –¥–ª—è –±–æ–Ω—É—Å—É! üåøüî¨ ${window.location.href}?code=${promoCode}`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
      window.open(whatsappUrl, '_blank');
      trackSharedCode(promoCode);
      closeSharePopup();
    }

    function copyShareLink() {
      const promoCode = getRandomInviteCode();
      const shareText = `–ü—Ä–∏—î–¥–Ω—É–π—Å—è –¥–æ BioWorld —Ç–∞ –¥—ñ–∑–Ω–∞–π—Å—è –±—ñ–ª—å—à–µ –ø—Ä–æ –±—ñ–æ–ª–æ–≥—ñ—é! –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π –ø—Ä–æ–º–æ–∫–æ–¥ ${promoCode} –¥–ª—è –±–æ–Ω—É—Å—É! üåøüî¨ ${window.location.href}?code=${promoCode}`;
      navigator.clipboard.writeText(shareText).then(() => {
        showNotification('–ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –¥–æ –±—É—Ñ–µ—Ä–∞ –æ–±–º—ñ–Ω—É!');
        trackSharedCode(promoCode);
        closeSharePopup();
      });
    }

    function getRandomInviteCode() {
      const inviteCodes = ['invite1', 'invite2', 'invite3', 'invite4', 'invite5'];
      return inviteCodes[Math.floor(Math.random() * inviteCodes.length)];
    }

    function trackSharedCode(code) {
      const sharedCodes = JSON.parse(localStorage.getItem('sharedCodes') || '{}');
      sharedCodes[code] = (sharedCodes[code] || 0) + 1;
      localStorage.setItem('sharedCodes', JSON.stringify(sharedCodes));
      const reward = promoCodes[code].reward;
      xpPoints += reward;
      localStorage.setItem('xpPoints', xpPoints);
      const user = auth.currentUser;
      if (user) {
        update(ref(database, 'users/' + user.uid), { xpPoints: xpPoints });
        addAchievement('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –¥—Ä—É–≥–∞');
      }
      showNotification(`–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ ${reward} XP –∑–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è –¥—Ä—É–≥–∞!`);
      updateXPProgress();
    }

    function redirectToRandomTest() {
      const tests = [
        'Quz/QPetInst.html',
        'Quz/QPetOrg.html',
        'Quz/QPlosCherv.html',
        'Quz/QPetIn.html'
      ];
      const randomTest = tests[Math.floor(Math.random() * tests.length)];
      location.href = randomTest;
      xpPoints += 10;
      localStorage.setItem('xpPoints', xpPoints);
      const user = auth.currentUser;
      if (user) {
        update(ref(database, 'users/' + user.uid), { xpPoints: xpPoints });
        addAchievement('–í–∏–ø–∞–¥–∫–æ–≤–∏–π —Ç–µ—Å—Ç');
      }
      showNotification('–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 10 XP –∑–∞ –≤–∏–±—ñ—Ä –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ —Ç–µ—Å—Ç—É!');
      updateXPProgress();
    }

    function openSettings() {
      document.getElementById('settings').style.display = 'block';
    }

    function closeSettings() {
      document.getElementById('settings').style.display = 'none';
    }

    function applySettings() {
      const theme = document.getElementById('themeSelect').value;
      const animations = document.getElementById('animationToggle').checked;
      const customBg = document.getElementById('bgInput').value;

      localStorage.setItem('theme', theme);
      localStorage.setItem('animations', animations);
      if (customBg) {
        localStorage.setItem('customBg', customBg);
      } else {
        localStorage.removeItem('customBg');
      }

      applyTheme(theme, customBg, animations);

      const user = auth.currentUser;
      if (user) {
        update(ref(database, 'users/' + user.uid), {
          theme: theme,
          customBg: customBg || '',
          animations: animations,
          achievements: JSON.parse(localStorage.getItem('userAchievements') || '[]')
        });
        addAchievement('–ó–º—ñ–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å');
      }

      closeSettings();
      xpPoints += 5;
      localStorage.setItem('xpPoints', xpPoints);
      if (user) {
        update(ref(database, 'users/' + user.uid), { xpPoints: xpPoints });
      }
      showNotification('–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 5 XP –∑–∞ –∑–º—ñ–Ω—É –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å!');
      updateXPProgress();
    }

    function installApp() {
      if (window.deferredPrompt) {
        window.deferredPrompt.prompt();
        window.deferredPrompt.userChoice.then(choiceResult => {
          if (choiceResult.outcome === 'accepted') {
            console.log('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—Å—Ç–∞–Ω–æ–≤–∏–≤ –¥–æ–¥–∞—Ç–æ–∫');
            xpPoints += 30;
            localStorage.setItem('xpPoints', xpPoints);
            const user = auth.currentUser;
            if (user) {
              update(ref(database, 'users/' + user.uid), { xpPoints: xpPoints });
              addAchievement('–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É');
            }
            showNotification('–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 30 XP –∑–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É!');
            updateXPProgress();
          }
          window.deferredPrompt = null;
        });
      } else {
        showNotification('–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ. –°–ø—Ä–æ–±—É–π—Ç–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏ —Å–∞–π—Ç —É –±—Ä–∞—É–∑–µ—Ä—ñ, —è–∫–∏–π –ø—ñ–¥—Ç—Ä–∏–º—É—î PWA (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Chrome –∞–±–æ Safari).');
      }
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      window.deferredPrompt = e;
    });

    window.onload = function() {
      const savedTheme = localStorage.getItem('theme');
      const savedBg = localStorage.getItem('customBg');
      const animations = localStorage.getItem('animations') !== 'false';
      applyTheme(savedTheme || 'default', savedBg, animations);

      onAuthStateChanged(auth, user => {
        console.log('Auth state changed:', user ? 'User logged in' : 'No user');
        if (user) {
          localStorage.setItem('userId', user.uid);
          // Real-time listener for user data
          const userRef = ref(database, 'users/' + user.uid);
          window.userListener = onValue(userRef, (snapshot) => {
            const userData = snapshot.val();
            if (userData) {
              console.log('User data synced:', userData);
              syncUserData(userData);
            } else {
              console.warn('No user data found in database');
            }
          }, (error) => {
            console.error('–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö:', error.message);
            showNotification('–ü–æ–º–∏–ª–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –¥–∞–Ω–∏—Ö: ' + error.message);
          });
        } else {
          console.log('Showing login form');
          document.getElementById('accountForm').style.display = 'block';
          document.getElementById('accountInfo').style.display = 'none';
          document.getElementById('welcomeBanner').style.display = 'none';
          if (window.userListener) {
            window.userListener();
            window.userListener = null;
          }
        }
      });

      updateXPProgress();
      updatePromoHistory();
      updateAchievements();
    };

    function togglePopup() {
      const popup = document.getElementById('accountPopup');
      popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
      console.log('Toggled account popup, display:', popup.style.display);
    }

    function registerAccount() {
      const name = document.getElementById('usernameInput').value.trim();
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value.trim();
      const avatarFile = document.getElementById('avatarInput').files[0];

      if (!name || !email || !password || !avatarFile) {
        showNotification('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —ñ–º‚Äô—è, –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É –ø–æ—à—Ç—É, –ø–∞—Ä–æ–ª—å —Ç–∞ –≤–∏–±–µ—Ä—ñ—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É!');
        console.warn('Registration failed: Missing required fields');
        return;
      }

      compressImage(avatarFile, function(compressedUrl) {
        createUserWithEmailAndPassword(auth, email, password)
          .then(userCredential => {
            const user = userCredential.user;
            console.log('User registered:', user.uid);
            return updateProfile(user, {
              displayName: name,
              photoURL: compressedUrl
            }).then(() => {
              return set(ref(database, 'users/' + user.uid), {
                username: name,
                email: email,
                avatar: compressedUrl,
                xpPoints: xpPoints,
                visits: 1,
                lastLogin: new Date().toISOString(),
                achievements: JSON.parse(localStorage.getItem('userAchievements') || '[]'),
                promoHistory: JSON.parse(localStorage.getItem('promoHistory') || '[]'),
                usedPromoCodes: JSON.parse(localStorage.getItem('usedPromoCodes') || '[]'),
                userBadges: JSON.parse(localStorage.getItem('userBadges') || '[]'),
                unlockedLessons: JSON.parse(localStorage.getItem('unlockedLessons') || '[]'),
                loginHistory: JSON.parse(localStorage.getItem('loginHistory') || '{}'),
                theme: localStorage.getItem('theme') || 'default',
                customBg: localStorage.getItem('customBg') || '',
                animations: localStorage.getItem('animations') !== 'false'
              });
            }).then(() => {
              localStorage.setItem('bioUsername', name);
              localStorage.setItem('bioAvatar', compressedUrl);
              localStorage.setItem('bioVisits', 1);
              localStorage.setItem('userId', user.uid);
              updateLoginHistory();
              // No automatic login after registration to avoid issues
              xpPoints += 20;
              localStorage.setItem('xpPoints', xpPoints);
              update(ref(database, 'users/' + user.uid), { xpPoints: xpPoints });
              addAchievement('–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∞–∫–∞—É–Ω—Ç—É');
              showNotification('–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 20 XP –∑–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é!');
              syncUserData({
                username: name,
                avatar: compressedUrl,
                visits: 1,
                xpPoints: xpPoints,
                achievements: JSON.parse(localStorage.getItem('userAchievements') || '[]'),
                promoHistory: JSON.parse(localStorage.getItem('promoHistory') || '[]'),
                usedPromoCodes: JSON.parse(localStorage.getItem('usedPromoCodes') || '[]'),
                userBadges: JSON.parse(localStorage.getItem('userBadges') || '[]'),
                unlockedLessons: JSON.parse(localStorage.getItem('unlockedLessons') || '[]'),
                loginHistory: JSON.parse(localStorage.getItem('loginHistory') || '{}'),
                theme: localStorage.getItem('theme') || 'default',
                customBg: localStorage.getItem('customBg') || '',
                animations: localStorage.getItem('animations') !== 'false'
              });
              console.log('Registration successful, user data synced');
            });
          })
          .catch(error => {
            console.error('–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó:', error.message);
            showNotification('–ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó: ' + error.message);
          });
      });
    }

    function loginAccount() {
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passwordInput').value.trim();

      if (!email || !password) {
        showNotification('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—É –ø–æ—à—Ç—É —Ç–∞ –ø–∞—Ä–æ–ª—å!');
        console.warn('Login failed: Missing email or password');
        return;
      }

      signInWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          const user = userCredential.user;
          console.log('User logged in:', user.uid);
          localStorage.setItem('userId', user.uid);
          const visits = parseInt(localStorage.getItem('bioVisits') || 0) + 1;
          localStorage.setItem('bioVisits', visits);
          update(ref(database, 'users/' + user.uid), { visits: visits });
          updateLoginHistory();
          xpPoints += 10;
          localStorage.setItem('xpPoints', xpPoints);
          update(ref(database, 'users/' + user.uid), { xpPoints: xpPoints });
          addAchievement('–í—Ö—ñ–¥ –¥–æ –∞–∫–∞—É–Ω—Ç—É');
          showNotification('–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 10 XP –∑–∞ –≤—Ö—ñ–¥!');
          // The onAuthStateChanged listener will handle UI updates
        })
        .catch(error => {
          console.error('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É:', error.message);
          showNotification('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ' + error.message);
        });
    }

    function showAccountInfo(name, avatarUrl, visits) {
      console.log('Showing account info for:', name, 'Visits:', visits);
      const accountForm = document.getElementById('accountForm');
      const accountInfo = document.getElementById('accountInfo');
      const welcomeBanner = document.getElementById('welcomeBanner');

      if (accountForm && accountInfo && welcomeBanner) {
        accountForm.style.display = 'none';
        accountInfo.style.display = 'block';
        welcomeBanner.style.display = 'block';
      } else {
        console.error('DOM elements not found:', { accountForm, accountInfo, welcomeBanner });
        showNotification('–ü–æ–º–∏–ª–∫–∞: –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç–∏ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É');
        return;
      }

      document.getElementById('displayName').textContent = name || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
      document.getElementById('userAvatar').src = avatarUrl || '';
      document.getElementById('visitCount').textContent = visits || 0;
      setTimeGreeting();
      drawLoginChart();
      updateXPProgress();
      updatePromoHistory();
      updateAchievements();
    }

    function logout() {
      signOut(auth).then(() => {
        console.log('User logged out');
        localStorage.removeItem('userId');
        localStorage.removeItem('bioUsername');
        localStorage.removeItem('bioAvatar');
        localStorage.removeItem('bioVisits');
        document.getElementById('accountForm').style.display = 'block';
        document.getElementById('accountInfo').style.display = 'none';
        document.getElementById('welcomeBanner').style.display = 'none';
        if (window.userListener) {
          window.userListener();
          window.userListener = null;
        }
      }).catch(error => {
        console.error('–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É:', error.message);
        showNotification('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
      });
    }

    function editProfile() {
      const name = prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–µ —ñ–º'—è", localStorage.getItem('bioUsername'));
      if (name) {
        const user = auth.currentUser;
        if (user) {
          updateProfile(user, {
            displayName: name
          }).then(() => {
            localStorage.setItem('bioUsername', name);
            update(ref(database, 'users/' + user.uid), {
              username: name,
              achievements: JSON.parse(localStorage.getItem('userAchievements') || '[]')
            });
            showAccountInfo(name, localStorage.getItem('bioAvatar'), localStorage.getItem('bioVisits'));
            xpPoints += 5;
            localStorage.setItem('xpPoints', xpPoints);
            update(ref(database, 'users/' + user.uid), {
              xpPoints: xpPoints
            });
            addAchievement('–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é');
            showNotification('–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 5 XP –∑–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é!');
            updateXPProgress();
          });
        }
      }
    }

    function changeAvatar() {
      const avatarInput = document.createElement('input');
      avatarInput.type = 'file';
      avatarInput.accept = 'image/*';
      avatarInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          compressImage(file, function(compressedUrl) {
            const user = auth.currentUser;
            if (user) {
              updateProfile(user, {
                photoURL: compressedUrl
              }).then(() => {
                localStorage.setItem('bioAvatar', compressedUrl);
                update(ref(database, 'users/' + user.uid), {
                  avatar: compressedUrl,
                  achievements: JSON.parse(localStorage.getItem('userAchievements') || '[]')
                });
                document.getElementById('userAvatar').src = compressedUrl;
                xpPoints += 5;
                localStorage.setItem('xpPoints', xpPoints);
                update(ref(database, 'users/' + user.uid), {
                  xpPoints: xpPoints
                });
                addAchievement('–ó–º—ñ–Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏');
                showNotification('–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏ 5 XP –∑–∞ –∑–º—ñ–Ω—É –∞–≤–∞—Ç–∞—Ä–∫–∏!');
                updateXPProgress();
              });
            }
          });
        }
      };
      avatarInput.click();
    }

    function setTimeGreeting() {
      const hours = new Date().getHours();
      const greeting = hours < 12 ? "–î–æ–±—Ä–∏–π —Ä–∞–Ω–æ–∫!" : (hours < 18 ? "–î–æ–±—Ä–∏–π –¥–µ–Ω—å!" : "–î–æ–±—Ä–∏–π –≤–µ—á—ñ—Ä!");
      document.getElementById('timeGreeting').textContent = greeting;
    }

    function updateLoginHistory() {
      const user = auth.currentUser;
      if (user) {
        const loginHistory = JSON.parse(localStorage.getItem('loginHistory') || '{}');
        const today = new Date().toISOString().split('T')[0];
        loginHistory[today] = (loginHistory[today] || 0) + 1;
        localStorage.setItem('loginHistory', JSON.stringify(loginHistory));
        update(ref(database, 'users/' + user.uid), {
          loginHistory: loginHistory,
          achievements: JSON.parse(localStorage.getItem('userAchievements') || '[]')
        });
      }
    }

    function drawLoginChart() {
      const loginHistory = JSON.parse(localStorage.getItem('loginHistory') || '{}');
      const labels = Object.keys(loginHistory).slice(-7);
      const data = labels.map(date => loginHistory[date] || 0);

      const ctx = document.getElementById('loginChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '–í—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–Ω—è –∑–∞ –¥–µ–Ω—å',
            data: data,
            backgroundColor: 'rgba(46, 125, 50, 0.5)',
            borderColor: 'rgba(46, 125, 50, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: '–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤—Ö–æ–¥—ñ–≤'
              }
            },
            x: {
              title: {
                display: true,
                text: '–î–∞—Ç–∞'
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(registration => {
        registration.onupdatefound = () => {
          const newWorker = registration.installing;
          newWorker.onstatechange = () => {
            if (newWorker.state === 'installed') {
              if (navigator.serviceWorker.controller) {
                document.getElementById('update-loader').style.display = 'flex';
                setTimeout(() => {
                  window.location.reload();
                }, 2000);
              }
            }
          };
        };
      }).catch(err => {
        console.error('SW —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–µ –≤–¥–∞–ª–∞—Å—è üò•:', err);
      });
    }
  </script>
  <script defer data-domain="bropetro.github.io/bioword.github.io" src="https://plausible.io/js/script.outbound-links.js"></script>
</body>
</html>
